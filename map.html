<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ToiToi Tracker â€“ Vilnius Map</title>

  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;700&display=swap" rel="stylesheet">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #07829d;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      opacity: 0;
      transition: opacity 0.6s ease;
    }
    body.fade-in {
      opacity: 1;
    }

    h1 { margin: 16px 0 8px 0; }
    .subtitle { margin-bottom: 12px; opacity: 0.9; }

    #map-wrapper {
      position: relative;
      width: 95%;
      max-width: 1400px;
      height: 75vh;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      background: #ddd;
    }
    #map { width: 100%; height: 100%; }
    .hint { margin-top: 10px; opacity: 0.85; }


    /* ===== InfoWindow ===== */
    .info-card {
      max-width: 240px;
      color: #111;
      font-family: Arial, sans-serif;
    }
    .info-title {
      margin: 2px 0 4px 0;
      font-size: 15px;
      font-weight: 700;
    }
    .info-rating-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }
    .stars {
      color: rgb(247,210,0);
      font-size: 22px;
    }
    .info-rating-value {
      font-size: 15px;
      color: #555;
    }
    .info-section-title {
      margin: 4px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .info-reviews {
      max-height: 160px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .review-block {
      margin-top: 6px;
      padding: 6px 7px;
      background: #f7f7f7;
      border-radius: 6px;
      border-left: 3px solid #0099cc;
      font-size: 13px;
      color: #333;
    }
    .review-rating {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .add-review-btn {
      width: 100%;
      margin-top: 8px;
      background: #07829d;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }


    /* ===== MODAL ===== */
    .modal-hidden { display: none; }

    #review-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 99999;
    }
    .modal-backdrop {
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(2px);
      position: absolute;
    }

    .modal-window {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 330px;
      background: white;
      color: black;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      animation: pop 0.25s ease;
      font-family: Arial, sans-serif;
    }

    @keyframes pop {
      0% { transform: translate(-50%, -45%) scale(0.9); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .modal-window h2 {
      margin: 0 0 6px 0;
      font-size: 20px;
      font-weight: 700;
    }

    #modal-toilet-name {
      margin-bottom: 12px;
      opacity: 0.7;
      font-size: 14px;
    }

    .modal-stars span {
      font-size: 30px;
      cursor: pointer;
      color: #ccc;
    }
    .modal-stars .selected {
      color: rgb(247,210,0);
    }

    #modal-comment {
      width: 100%;
      height: 80px;
      border-radius: 6px;
      border: 1px solid #bbb;
      padding: 6px;
      resize: none;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
    }
    #modal-cancel {
      background: #ddd;
      border: none;
      padding: 7px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    #modal-submit {
      background: #07829d;
      color: white;
      border: none;
      padding: 7px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body>

  <h1>ToiToi Toilets in Vilnius</h1>
  <div class="subtitle">Use the mouse wheel to zoom in and out on Vilnius.</div>

  <div id="map-wrapper"><div id="map"></div></div>

  <div class="hint">Map is locked to Vilnius area.</div>


  <!-- ===== MODAL ===== -->
  <div id="review-modal" class="modal-hidden">
    <div class="modal-backdrop"></div>

    <div class="modal-window">
      <h2>Add Review</h2>
      <p id="modal-toilet-name"></p>

      <div id="modal-stars" class="modal-stars">
        <span>â˜…</span><span>â˜…</span><span>â˜…</span><span>â˜…</span><span>â˜…</span>
      </div>

      <textarea id="modal-comment" placeholder="Write your comment..."></textarea>

      <div class="modal-buttons">
        <button id="modal-cancel">Cancel</button>
        <button id="modal-submit">Submit</button>
      </div>
    </div>
  </div>



  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.body.classList.add("fade-in");
    });

    async function initMap() {
      // ðŸ”¹ Ð‘ÐµÑ€Ñ‘Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð‘Ð” Ñ‡ÐµÑ€ÐµÐ· get_data.php
      const apiData = await fetch("get_data.php").then(r => r.json());
      const toilets = apiData.toilets;
      const reviews = apiData.reviews;


      const vilniusBounds = {
        north: 54.8325, south: 54.5694, east: 25.4592, west: 25.0219,
      };
      const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 54.6872, lng: 25.2797 },
        zoom: 11,
        minZoom: 11,
        maxZoom: 18,
        restriction: { latLngBounds: vilniusBounds, strictBounds: true },
        gestureHandling: "greedy",
      });

      const infoWindow = new google.maps.InfoWindow();

     function generateStars(a) {
    const num = Number(a);

     if (isNaN(num) || num <= 0) {
     return "â˜†â˜†â˜†â˜†â˜†"; 
    }

    const r = Math.min(5, Math.max(0, Math.round(num))); // saugiklis nuo - skaiÄiÅ³
    return "â˜…".repeat(r) + "â˜†".repeat(5 - r);
    }


      toilets.forEach(t => {
        const [lat, lng] = t.location.split(',').map(Number);

        const marker = new google.maps.Marker({ position: { lat, lng }, map });

        marker.addListener("click", () => {
          const toiletReviews = reviews.filter(r => r.toilet_id == t.id);

          let avg = null;
          if (toiletReviews.length)
          avg = toiletReviews.reduce((s, r) => s + Number(r.rating), 0) / toiletReviews.length;

          let reviewsHTML = toiletReviews.map(r => `
            <div class="review-block">
              <div class="review-rating">${r.rating}/5</div>
              <div>${r.comment}</div>
            </div>`).join('');

          if (!reviewsHTML) reviewsHTML = "<i>No reviews yet.</i>";

          const infoHTML = `
            <div class="info-card">
              <h3 class="info-title">${t.name}</h3>

              <div class="info-rating-row">
                <div class="stars">${generateStars(avg)}</div>
                <div class="info-rating-value">
                  ${avg ? avg.toFixed(1) + " / 5" : "No rating"}
                </div>
              </div>

              <div class="info-section-title">Reviews</div>
              <div class="info-reviews">${reviewsHTML}</div>

              <button class="add-review-btn" data-id="${t.id}" data-name="${t.name}">
                Add your review
              </button>
            </div>`;

          infoWindow.setContent(infoHTML);
          infoWindow.open(map, marker);
        });
      });
    }

    /* ===== MODAL LOGIC ===== */
    let currentToiletId = null;
    let currentRating = 0;

    // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð¾Ð´Ð°Ð»ÐºÐ¸ Ð¿Ñ€Ð¸ ÐºÐ»Ð¸ÐºÐµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð² InfoWindow
    document.body.addEventListener("click", e => {
      if (e.target.classList.contains("add-review-btn")) {
        currentToiletId = e.target.dataset.id;
        document.getElementById("modal-toilet-name").textContent = e.target.dataset.name;
        document.getElementById("review-modal").classList.remove("modal-hidden");
      }
    });

    // Ð’Ñ‹Ð±Ð¾Ñ€ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° (Ð·Ð²Ñ‘Ð·Ð´Ð¾Ñ‡ÐºÐ¸)
    document.querySelectorAll("#modal-stars span").forEach((s, i) => {
      s.onclick = () => {
        currentRating = i + 1;
        document.querySelectorAll("#modal-stars span").forEach((a, j) => {
          if (j < currentRating) a.classList.add("selected");
          else a.classList.remove("selected");
        });
      };
    });

    // Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð¾Ð´Ð°Ð»ÐºÐ¸
    document.getElementById("modal-cancel").onclick = () => {
      document.getElementById("review-modal").classList.add("modal-hidden");
      currentRating = 0;
      document.querySelectorAll("#modal-stars span").forEach(s => s.classList.remove("selected"));
      document.getElementById("modal-comment").value = "";
    };

    document.getElementById("modal-submit").onclick = async () => {
  const comment = document.getElementById("modal-comment").value.trim();
  if (!currentRating) return alert("Select rating");
  if (!comment) return alert("Write comment");

  const formData = new FormData();
  formData.append("toilet_id", Number(currentToiletId));
  formData.append("rating", currentRating);
  formData.append("comment", comment);

  try {
    const res = await fetch("add_review.php", {
      method: "POST",
      body: formData
    });

    const json = await res.json();

    if (json.success) {
      alert("Review added!");
      location.reload();
    } else {
      alert("Error: " + json.error);
    }
  } catch (e) {
    alert("Request failed");
  }
};
  </script>

<script async     
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCN0hf86N7hsmgW3yMbWPZNng3pDv0N1Nc&callback=initMap">
</script>

</body>
</html>
